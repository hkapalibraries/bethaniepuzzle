<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BÃ©thanie Puzzle - ä¼¯å¤§å°¼æ‹¼åœ– (Game Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #f8fafc;
            overflow-x: hidden;
            /* é‡å°æ‰‹æ©Ÿå„ªåŒ–ï¼šç¦æ­¢é•·æŒ‰é¸å–®èˆ‡æ–‡å­—é¸å– */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* --- æ‹¼åœ–æ¿å®¹å™¨ (4:3) --- */
        .puzzle-drop-zone {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            width: 300px;
            height: 225px;
            background: #e2e8f0;
            border: 2px solid #cbd5e1;
            position: relative;
            transition: gap 0.3s ease;
        }

        .slot {
            width: 100px;
            height: 75px;
            border: 1px dashed #94a3b8;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        
        /* PC æ‹–æ›³é«˜äº®æ¨£å¼ */
        .slot.drag-over {
            background-color: rgba(99, 102, 241, 0.2) !important;
            border-color: #6366f1 !important;
        }

        /* æ‰‹æ©Ÿé¸å–é«˜äº®æ¨£å¼ */
        .has-selection .slot:not(:has(*)):active {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .pieces-pool-dock {
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (max-width: 1023px) {
            .pieces-pool-dock {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                border-radius: 24px;
                padding: 15px;
            }
            .pieces-pool-dock.minimized {
                transform: translate(-50%, calc(100% - 40px));
            }
            .pieces-pool-content {
                display: flex;
                flex-wrap: wrap;
                flex-direction: row;
                gap: 12px;
                justify-content: center;
                max-height: 140px;
                overflow-y: auto;
            }
        }

        @media (min-width: 1024px) {
            .pieces-pool-dock {
                position: relative;
                width: 180px;
                height: 450px;
                border-radius: 20px;
                padding: 15px 10px;
                display: flex;
                flex-direction: column;
                box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
                background: rgba(241, 245, 249, 0.5);
            }
            .pieces-pool-content {
                display: flex;
                flex-direction: column;
                gap: 15px;
                align-items: center;
                overflow-y: auto;
                height: 100%;
                padding-right: 5px;
            }
            .dock-toggle-btn-container { display: none; }
        }

        .puzzle-piece {
            width: 80px;
            height: 60px;
            cursor: grab;
            background-size: 240px 180px; 
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
            position: relative;
        }

        .puzzle-piece:active {
            cursor: grabbing;
        }

        /* æ‰‹æ©Ÿæ¨¡å¼é¸ä¸­æ¨£å¼ */
        .puzzle-piece.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px #6366f1, 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            z-index: 50;
        }

        .puzzle-piece.placed {
            width: 100px;
            height: 75px;
            background-size: 300px 225px;
            cursor: default;
            box-shadow: none;
            border-radius: 0;
            transform: none !important;
            z-index: 1;
            position: relative !important;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-shake { animation: shake 0.4s ease-in-out; }

        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .reference-container {
            width: 300px;
            height: 225px;
        }

        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        #win-modal {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <canvas id="confetti-canvas"></canvas>

    <!-- å‹åˆ©å½ˆçª— -->
    <div id="win-modal" class="fixed inset-0 z-[1000] hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-[90%] shadow-2xl transform scale-90 transition-transform duration-300 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
            <div class="mb-4 text-6xl">ğŸ†</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-1">æ­å–œå®Œæˆ!</h3>
            <p class="text-sm text-gray-400 mb-6 uppercase tracking-wider">Mission Complete</p>
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-indigo-50 p-3 rounded-xl">
                    <span class="block text-xs text-indigo-400 font-bold uppercase">æ™‚é–“ Time</span>
                    <span id="modal-time" class="text-xl font-bold text-indigo-700">00:00</span>
                </div>
                <div class="bg-purple-50 p-3 rounded-xl">
                    <span class="block text-xs text-purple-400 font-bold uppercase">æ­¥æ•¸ Moves</span>
                    <span id="modal-moves" class="text-xl font-bold text-purple-700">0</span>
                </div>
            </div>
            <div class="space-y-3">
                <button onclick="resetGame(true)" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition shadow-lg shadow-indigo-200">å†ç©ä¸€æ¬¡ Play Again</button>
                <button onclick="closeModal(); showSection('album')" class="w-full py-3 bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 font-bold rounded-xl transition">è¿”å›ç›¸ç°¿ Back to Album</button>
            </div>
        </div>
    </div>

    <nav class="p-4 md:p-6 glass-morphism sticky top-0 z-50 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-indigo-200">ğŸ§©</div>
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-gray-800 leading-none">ä¼¯å¤§å°¼æ‹¼åœ–</h1>
                <span class="text-[10px] md:text-xs text-gray-500 tracking-wide">BÃ©thanie Puzzle</span>
            </div>
        </div>
        <div class="space-x-2">
            <button onclick="showSection('album')" class="px-3 md:px-5 py-2 rounded-full bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition text-sm font-medium shadow-sm">ç›¸ç°¿ Album</button>
            <button onclick="showSection('puzzle')" class="px-3 md:px-5 py-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 transition text-sm font-medium shadow-md shadow-indigo-200">æ‹¼åœ– Puzzle</button>
        </div>
    </nav>

    <main class="container mx-auto py-8 px-4 flex-grow">
        
        <!-- ç›¸ç°¿å€å¡Š -->
        <section id="album-section" class="space-y-8 animate-fade-in">
            <div class="text-center max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800">ä¼¯å¤§å°¼150å‘¨å¹´ <span class="block text-lg font-normal text-gray-400 mt-1">Celebrates 150 Years</span></h2>
                <p class="text-gray-500 mt-2">é¸æ“‡ä¸€å¼µç…§ç‰‡ï¼Œé–‹å§‹æ‚¨çš„æ‹¼åœ–æŒ‘æˆ°ã€‚</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <!-- ç›¸ç‰‡ 1 -->
                <div class="group relative overflow-hidden rounded-2xl shadow-lg bg-white cursor-pointer transform hover:-translate-y-1 transition duration-300" onclick="startPuzzle('https://www.hkapa.edu/f/academy/69992/1334c750/001.jpg?auto=format&fit=crop&w=600&q=80', 'ä¼¯å¤§å°¼å¤è¹Ÿæ ¡åœ’', 'BÃ©thanie Campus')">
                    <div class="relative h-64 overflow-hidden">
                        <img src="https://www.hkapa.edu/f/academy/69992/1334c750/001.jpg?auto=format&fit=crop&w=600&q=80" alt="ä¼¯å¤§å°¼å¤è¹Ÿæ ¡åœ’" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center backdrop-blur-[2px]">
                            <div class="bg-white/20 backdrop-blur-md border border-white/30 text-white px-6 py-2 rounded-full font-bold shadow-xl">â–¶ é–‹å§‹ Start</div>
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-lg text-gray-800">ä¼¯å¤§å°¼å¤è¹Ÿæ ¡åœ’</h3>
                        <p class="text-xs text-indigo-600 font-medium mb-2">BÃ©thanie Campus</p>
                        <p class="text-sm text-gray-500 line-clamp-2">æ–¼äºŒé›¶é›¶å…­å¹´é‡æ–°é–‹æ”¾å¾Œæˆç‚ºé›»å½±é›»è¦–å­¸é™¢æ ¡èˆ<br><span class="text-xs italic opacity-70">Reopened in 2006 as the home of Academy's School of Film and Television</span></p>
                    </div>
                </div>

                <!-- ç›¸ç‰‡ 2 -->
                <div class="group relative overflow-hidden rounded-2xl shadow-lg bg-white cursor-pointer transform hover:-translate-y-1 transition duration-300" onclick="startPuzzle('https://www.hkapa.edu/f/academy/69992/1334c750/005_bethanie_1761895895.jpg?auto=format&fit=crop&w=600&q=80', 'ä¼¯å¤§å°¼å°æ•™å ‚', 'Bethanie Chapel')">
                    <div class="relative h-64 overflow-hidden">
                        <img src="https://www.hkapa.edu/f/academy/69992/1334c750/005_bethanie_1761895895.jpg?auto=format&fit=crop&w=600&q=80" alt="ä¼¯å¤§å°¼å°æ•™å ‚" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center backdrop-blur-[2px]">
                            <div class="bg-white/20 backdrop-blur-md border border-white/30 text-white px-6 py-2 rounded-full font-bold shadow-xl">â–¶ é–‹å§‹ Start</div>
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-lg text-gray-800">ä¼¯å¤§å°¼å°æ•™å ‚</h3>
                        <p class="text-xs text-indigo-600 font-medium mb-2">BÃ©thanie Chapel</p>
                        <p class="text-sm text-gray-500 line-clamp-2">é€£çºŒå¤šå¹´æˆç‚ºæœ€å—æ­¡çš„å©šç¦®å ´åœ°ä¹‹ä¸€<br><span class="text-xs italic opacity-70">One of the hottest wedding locations for years</span></p>
                    </div>
                </div>

                <!-- ç›¸ç‰‡ 3 -->
                <div class="group relative overflow-hidden rounded-2xl shadow-lg bg-white cursor-pointer transform hover:-translate-y-1 transition duration-300" onclick="startPuzzle('https://www.hkapa.edu/f/academy/69992/1334c750/007_bethanie_1761897567.jpg?auto=format&fit=crop&w=600&q=80', 'ä¼¯å¤§å°¼åŠ‡é™¢', 'BÃ©thanie Theatre')">
                    <div class="relative h-64 overflow-hidden">
                        <img src="https://www.hkapa.edu/f/academy/69992/1334c750/007_bethanie_1761897567.jpg?auto=format&fit=crop&w=600&q=80" alt="ä¼¯å¤§å°¼åŠ‡é™¢" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center backdrop-blur-[2px]">
                            <div class="bg-white/20 backdrop-blur-md border border-white/30 text-white px-6 py-2 rounded-full font-bold shadow-xl">â–¶ é–‹å§‹ Start</div>
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-lg text-gray-800">ä¼¯å¤§å°¼åŠ‡é™¢</h3>
                        <p class="text-xs text-indigo-600 font-medium mb-2">BÃ©thanie Theatre</p>
                        <p class="text-sm text-gray-500 line-clamp-2">ç”±æ˜”æ—¥çš„ç‰›æ£šæ”¹å»ºè€Œæˆï¼Œå¯ä½œé›»å½±æ”¾æ˜ ç­‰æ´»å‹•ä¹‹ç”¨<br><span class="text-xs italic opacity-70">Converted from a cowshed to serve as a venue for film screenings and more.</span></p>
                    </div>
                </div>

                <!-- ç›¸ç‰‡ 4 -->
                <div class="group relative overflow-hidden rounded-2xl shadow-lg bg-white cursor-pointer transform hover:-translate-y-1 transition duration-300" onclick="startPuzzle('http://hkapa.edu/f/academy/69992/1334c750/006_bethanie.jpg?auto=format&fit=crop&w=600&q=80', 'åŒ…ç‰å‰›ç¦®å ‚', 'Sir YK Pao Studio')">
                    <div class="relative h-64 overflow-hidden">
                        <img src="http://hkapa.edu/f/academy/69992/1334c750/006_bethanie.jpg?auto=format&fit=crop&w=600&q=80" alt="åŒ…ç‰å‰›ç¦®å ‚" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center backdrop-blur-[2px]">
                            <div class="bg-white/20 backdrop-blur-md border border-white/30 text-white px-6 py-2 rounded-full font-bold shadow-xl">â–¶ é–‹å§‹ Start</div>
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-lg text-gray-800">åŒ…ç‰å‰›ç¦®å ‚</h3>
                        <p class="text-xs text-indigo-600 font-medium mb-2">Sir YK Pao Studio</p>
                        <p class="text-sm text-gray-500 line-clamp-2">ä»¥åå°„ç†±åŠ›çš„æ·±è‰²ç»ç’ƒå¢æ·»æ¡å…‰åº¦å’Œç©ºé–“<br><span class="text-xs italic opacity-70">Featuring glazed insulated glass for better lighting</span></p>
                    </div>
                </div>

                <!-- ç›¸ç‰‡ 5 -->
                <div class="group relative overflow-hidden rounded-2xl shadow-lg bg-white cursor-pointer transform hover:-translate-y-1 transition duration-300" onclick="startPuzzle('https://www.hkapa.edu/f/academy/69992/1334c750/APA021.jpg?auto=format&fit=crop&w=600&q=80', 'ä¼¯å¤§å°¼åšç‰©é¤¨', 'BÃ©thanie Museum')">
                    <div class="relative h-64 overflow-hidden">
                        <img src="https://www.hkapa.edu/f/academy/69992/1334c750/APA021.jpg?auto=format&fit=crop&w=600&q=80" alt="æ³•åœ‹å·´é»éŠ€è¡Œä¼¯å¤§å°¼åšç‰©é¤¨" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center backdrop-blur-[2px]">
                            <div class="bg-white/20 backdrop-blur-md border border-white/30 text-white px-6 py-2 rounded-full font-bold shadow-xl">â–¶ é–‹å§‹ Start</div>
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-lg text-gray-800">æ³•åœ‹å·´é»éŠ€è¡Œä¼¯å¤§å°¼åšç‰©é¤¨</h3>
                        <p class="text-xs text-indigo-600 font-medium mb-2">BÃ©thanie Museum</p>
                        <p class="text-sm text-gray-500 line-clamp-2">åœ°ä¸‹é…’çª–è¢«æ´»åŒ–ç‚ºåšç‰©é¤¨ï¼Œè¨˜éŒ„ç€é€™è£¡çš„ç™¾å¹´è®Šé·<br><span class="text-xs italic opacity-70">Wine cellar has been repurposed into a gallery displaying the history of the site</span></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ‹¼åœ–å€å¡Š -->
        <section id="puzzle-section" class="hidden flex flex-col items-center space-y-6 animate-fade-in">
            <div class="w-full max-w-4xl flex items-center justify-between bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex items-center gap-4">
                    <div class="text-left">
                        <h2 id="puzzle-title-zh" class="text-lg font-bold text-gray-800 leading-tight">æ‹¼åœ–éŠæˆ²</h2>
                        <span id="puzzle-title-en" class="text-xs text-gray-400 font-normal">Puzzle Game</span>
                    </div>
                </div>
                <div class="flex gap-4 md:gap-8">
                    <div class="text-center">
                        <span class="block text-[10px] uppercase text-gray-400 font-bold tracking-wider">æ™‚é–“ Time</span>
                        <span id="game-timer" class="font-mono text-xl md:text-2xl font-bold text-indigo-600">00:00</span>
                    </div>
                    <div class="text-center border-l border-gray-100 pl-4 md:pl-8">
                        <span class="block text-[10px] uppercase text-gray-400 font-bold tracking-wider">æ­¥æ•¸ Moves</span>
                        <span id="move-count" class="font-mono text-xl md:text-2xl font-bold text-purple-600">0</span>
                    </div>
                </div>
            </div>

            <p id="puzzle-status" class="text-indigo-600 font-medium bg-indigo-50 px-6 py-2 rounded-full text-sm text-center">
                é–‹å§‹æŒ‘æˆ°ï¼
            </p>

            <div class="w-full max-w-6xl bg-white p-6 md:p-10 rounded-3xl shadow-2xl flex flex-col space-y-10 items-center border border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-50 rounded-full filter blur-3xl opacity-50 -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                <div id="puzzle-container-wrapper" class="flex flex-col lg:flex-row items-center justify-center gap-8 xl:gap-12 w-full relative z-10">
                    <div class="flex flex-col items-center space-y-3">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest block">æ”¾ç½®å€ Zone</span>
                        <div id="puzzle-board" class="puzzle-drop-zone rounded-lg overflow-hidden shadow-inner">
                            <div class="slot" data-index="0"></div>
                            <div class="slot" data-index="1"></div>
                            <div class="slot" data-index="2"></div>
                            <div class="slot" data-index="3"></div>
                            <div class="slot" data-index="4"></div>
                            <div class="slot" data-index="5"></div>
                            <div class="slot" data-index="6"></div>
                            <div class="slot" data-index="7"></div>
                            <div class="slot" data-index="8"></div>
                        </div>
                    </div>
                    <div id="pieces-dock" class="pieces-pool-dock flex flex-col">
                        <div class="flex lg:flex-col items-center justify-between mb-4 lg:mb-2 px-4 lg:px-0">
                            <div class="lg:mb-2 text-center pt-2 lg:pt-0">
                                <span class="text-[12px] lg:text-xs font-bold text-indigo-600 uppercase tracking-tighter block">å¾…é¸ç¢ç‰‡</span>
                                <span class="text-[10px] text-indigo-400 uppercase tracking-tighter block">Pieces</span>
                            </div>
                            <div class="dock-toggle-btn-container">
                                <button onclick="toggleDock()" class="text-gray-400 hover:text-indigo-600 p-2"><svg id="dock-icon" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
                            </div>
                        </div>
                        <div id="pieces-pool" class="pieces-pool-content pb-2"></div>
                    </div>
                    <div class="flex flex-col items-center space-y-3">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest block">åƒè€ƒåœ– Ref</span>
                        <div class="reference-container flex items-center justify-center bg-gray-50 rounded-lg overflow-hidden border-2 border-dashed border-gray-200 group">
                            <img id="reference-img" src="" class="max-w-full max-h-full object-cover opacity-50 group-hover:opacity-100 transition-opacity duration-300" alt="åƒè€ƒåœ–">
                        </div>
                    </div>
                </div>
                <div class="w-full flex justify-center gap-4 pt-4 border-t border-gray-100">
                    <button onclick="resetGame(true)" class="flex items-center px-6 py-2.5 bg-white border border-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-50 transition shadow-sm">é‡ç½® Reset</button>
                    <button onclick="showSection('album')" class="flex items-center px-6 py-2.5 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition shadow-md shadow-indigo-200">è¿”å› Back</button>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="container mx-auto px-4 py-6 text-center text-sm text-gray-500">
            <p>2026 BÃ©thanie Puzzle</p>
            <div class="mt-2 text-xs opacity-60">
                <a href="https://www.hkapa.edu/tch/academy-stories/the-b-thanie-celebrates150-years-nurturing-the-performing-arts-talents" target="_blank" class="hover:underline">ä¼¯å¤§å°¼èµ°é150 å¹´ åŸ¹è‚²æ¼”è—äººæ‰ (HKAPA)</a>
            </div>
        </div>
    </footer>

    <script>
        let currentImg = '';
        const gridSize = 3;
        let placedCount = 0;
        let moveCount = 0;
        let timerInterval;
        let seconds = 0;
        let isGameActive = false;
        
        const boardWidth = 300;
        const boardHeight = 225;
        const slotWidth = boardWidth / gridSize; 
        const slotHeight = boardHeight / gridSize; 
        const poolScale = 0.8;
        const poolPieceWidth = slotWidth * poolScale; 
        const poolPieceHeight = slotHeight * poolScale; 

        // ç›®å‰é¸å–çš„ç¢ç‰‡ (æ‰‹æ©Ÿæ¨¡å¼ç”¨)
        let selectedPiece = null;
        // åµæ¸¬è£ç½®é¡å‹
        const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration, vol = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        const sounds = {
            click: () => playTone(400, 'sine', 0.1, 0.05),
            drop: () => playTone(600, 'sine', 0.15, 0.1),
            error: () => playTone(150, 'sawtooth', 0.3, 0.1),
            win: () => {
                setTimeout(() => playTone(400, 'sine', 0.2), 0);
                setTimeout(() => playTone(500, 'sine', 0.2), 200);
                setTimeout(() => playTone(600, 'sine', 0.2), 400);
                setTimeout(() => playTone(800, 'square', 0.6), 600);
            }
        };

        function showSection(section) {
            document.getElementById('album-section').classList.toggle('hidden', section !== 'album');
            document.getElementById('puzzle-section').classList.toggle('hidden', section !== 'puzzle');
            document.getElementById('pieces-dock').classList.toggle('hidden', section !== 'puzzle');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if (section === 'album') { stopTimer(); isGameActive = false; deselectPiece(); }
        }

        function toggleDock() {
            const dock = document.getElementById('pieces-dock');
            const icon = document.getElementById('dock-icon');
            if (window.innerWidth < 1024) {
                dock.classList.toggle('minimized');
                icon.classList.toggle('rotate-180');
            }
        }

        function startTimer() { stopTimer(); seconds = 0; updateTimerDisplay(); timerInterval = setInterval(() => { seconds++; updateTimerDisplay(); }, 1000); }
        function stopTimer() { clearInterval(timerInterval); }
        function updateTimerDisplay() {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('game-timer').innerText = `${mins}:${secs}`;
            document.getElementById('modal-time').innerText = `${mins}:${secs}`;
        }

        function startPuzzle(imgUrl, titleZh, titleEn) {
            currentImg = imgUrl;
            document.getElementById('reference-img').src = imgUrl;
            document.getElementById('puzzle-title-zh').innerText = titleZh;
            document.getElementById('puzzle-title-en').innerText = titleEn + ' Puzzle';
            if (audioCtx.state === 'suspended') audioCtx.resume();
            showSection('puzzle');
            initGame();
        }

        function initGame() {
            placedCount = 0;
            moveCount = 0;
            isGameActive = true;
            deselectPiece();
            document.getElementById('move-count').innerText = '0';
            document.getElementById('puzzle-board').style.gap = '2px';
            
            if (isTouchDevice) {
                updateStatus('æ‰‹æ©Ÿæ¨¡å¼ï¼šé»æ“Šç¢ç‰‡å¾Œé»æ“Šç©ºæ ¼æ”¾ç½®', 'Mobile Mode: Click piece then click slot');
            } else {
                updateStatus('é›»è…¦æ¨¡å¼ï¼šè«‹ç›´æ¥æ‹–æ›³ç¢ç‰‡åˆ°æ­£ç¢ºä½ç½®', 'Desktop Mode: Drag and Drop pieces');
            }
            startTimer();

            const slots = document.querySelectorAll('.slot');
            slots.forEach(slot => {
                slot.innerHTML = '';
                slot.style.border = '1px dashed #94a3b8';
                
                // ç§»é™¤æ‰€æœ‰èˆŠäº‹ä»¶
                slot.onclick = null;
                slot.ondragover = null;
                slot.ondragleave = null;
                slot.ondrop = null;

                if (isTouchDevice) {
                    // æ‰‹æ©Ÿï¼šé»æ“Šæ§½ä½
                    slot.onclick = () => handleSlotClick(slot);
                } else {
                    // é›»è…¦ï¼šæ‹–æ”¾æ§½ä½
                    slot.addEventListener('dragover', handleDragOver);
                    slot.addEventListener('dragleave', handleDragLeave);
                    slot.addEventListener('drop', handleDrop);
                }
            });
            
            const pool = document.getElementById('pieces-pool');
            pool.innerHTML = '';
            const pieceIndices = Array.from({length: 9}, (_, i) => i).sort(() => Math.random() - 0.5);

            pieceIndices.forEach(idx => {
                const piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                piece.id = `piece-${idx}`;
                
                const row = Math.floor(idx / 3);
                const col = idx % 3;
                piece.style.backgroundImage = `url(${currentImg})`;
                piece.style.backgroundPosition = `-${col * poolPieceWidth}px -${row * poolPieceHeight}px`;
                
                if (isTouchDevice) {
                    piece.draggable = false;
                    piece.onclick = (e) => {
                        e.stopPropagation();
                        handlePieceClick(piece);
                    };
                } else {
                    piece.draggable = true;
                    piece.addEventListener('dragstart', handleDragStart);
                    piece.addEventListener('mousedown', () => sounds.click());
                }

                pool.appendChild(piece);
            });
        }

        function updateStatus(zh, en) {
            document.getElementById('puzzle-status').innerHTML = `${zh}<br><span class="text-xs opacity-75">${en}</span>`;
        }

        // --- é›»è…¦ç‰ˆæ‹–æ›³é‚è¼¯ ---
        function handleDragStart(e) { 
            e.dataTransfer.setData('text/plain', e.target.id); 
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragOver(e) { 
            e.preventDefault(); 
            if (!e.currentTarget.hasChildNodes()) e.currentTarget.classList.add('drag-over'); 
        }
        function handleDragLeave(e) { 
            e.currentTarget.classList.remove('drag-over'); 
        }
        function handleDrop(e) {
            e.preventDefault();
            const target = e.currentTarget;
            target.classList.remove('drag-over');
            const pieceId = e.dataTransfer.getData('text/plain');
            processPlacement(pieceId, target);
        }

        // --- æ‰‹æ©Ÿç‰ˆé»æ“Šé‚è¼¯ ---
        function handlePieceClick(piece) {
            if (!isGameActive || piece.classList.contains('placed')) return;
            if (selectedPiece === piece) { deselectPiece(); return; }
            deselectPiece();
            selectedPiece = piece;
            piece.classList.add('selected');
            document.getElementById('puzzle-board').classList.add('has-selection');
            sounds.click();
        }

        function handleSlotClick(slot) {
            if (!isGameActive || !selectedPiece || slot.hasChildNodes()) return;
            processPlacement(selectedPiece.id, slot);
        }

        function deselectPiece() {
            if (selectedPiece) { selectedPiece.classList.remove('selected'); selectedPiece = null; }
            document.getElementById('puzzle-board').classList.remove('has-selection');
        }

        // --- æ ¸å¿ƒæ”¾ç½®åˆ¤å®š (å…±ç”¨) ---
        function processPlacement(pieceId, targetSlot) {
            const piece = document.getElementById(pieceId);
            const pieceIndex = parseInt(pieceId.split('-')[1]);
            const slotIndex = parseInt(targetSlot.getAttribute('data-index'));

            moveCount++;
            document.getElementById('move-count').innerText = moveCount;

            if (pieceIndex === slotIndex) {
                sounds.drop();
                targetSlot.appendChild(piece);
                piece.classList.remove('selected');
                piece.classList.add('placed', 'animate-pop');
                piece.draggable = false;
                
                const col = pieceIndex % 3;
                const row = Math.floor(pieceIndex / 3);
                piece.style.backgroundPosition = `-${col * slotWidth}px -${row * slotHeight}px`;
                
                placedCount++;
                deselectPiece();
                checkWin();
            } else {
                sounds.error();
                piece.classList.add('animate-shake');
                setTimeout(() => piece.classList.remove('animate-shake'), 400);
                updateStatus('âŒ ä½ç½®ä¸å°å–”ï¼', 'Wrong position!');
                deselectPiece();
            }
        }

        function checkWin() {
            if (placedCount === 9) {
                isGameActive = false;
                stopTimer();
                sounds.win();
                updateStatus('ğŸ‰ å®Œæˆï¼', 'Completed!');
                document.getElementById('puzzle-board').style.gap = '0';
                document.querySelectorAll('.slot').forEach(s => { s.style.border = 'none'; s.onclick = null; });
                document.getElementById('modal-moves').innerText = moveCount;
                fireConfetti();
                setTimeout(openModal, 800);
            }
        }

        function resetGame(force = false) { if (force) { closeModal(); initGame(); } }
        function openModal() {
            const modal = document.getElementById('win-modal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.add('scale-100'); }, 10);
        }
        function closeModal() {
            const modal = document.getElementById('win-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function fireConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const particles = [];
            const colors = ['#6366f1', '#a855f7', '#ec4899', '#fbbf24'];
            for (let i = 0; i < 150; i++) {
                particles.push({
                    x: canvas.width/2, y: canvas.height/2,
                    w: Math.random()*10+5, h: Math.random()*10+5,
                    color: colors[Math.floor(Math.random()*colors.length)],
                    vx: (Math.random()-0.5)*18, vy: (Math.random()-0.5)*18-5,
                    grav: 0.2, rot: Math.random()*360, drot: (Math.random()-0.5)*10
                });
            }
            function update() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                let alive = false;
                particles.forEach(p => {
                    p.x+=p.vx; p.y+=p.vy; p.vy+=p.grav; p.rot+=p.drot;
                    if(p.y < canvas.height) { alive = true; ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot*Math.PI/180); ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore(); }
                });
                if(alive) requestAnimationFrame(update);
            }
            update();
        }
        window.addEventListener('resize', () => {
             const canvas = document.getElementById('confetti-canvas');
             canvas.width = window.innerWidth;
             canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
